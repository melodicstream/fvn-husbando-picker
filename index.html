<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FVN Husbando Picker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
</head>

<body class="has-background-grey-darker">
    <nav class="navbar has-background-info-dark" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <h1 class="navbar-item has-text-white-bis">Furry Visual Novel Husbando Picker</h1>
        </div>
    </nav>

    <section class="section">
        <div class="container">
            <div class="box">
                <p>
                    Welcome to the Furry Visual Novel Husbando Picker! The way this works is that you're presented with
                    two characters from Furry Visual Novels at once. You must decide which one of the two you like the
                    most. This will go on until you're rated all the characters. Once that is done, you'll be able to
                    see your ranking of husbandos, with the top one being the one that you love the most. Refresh the
                    page to try again if you'd like.
                </p>
            </div>
        </div>
        <br/>
        <div class="container" id="husbando-app">
            <div class="columns">
                <div class="column is-5">
                    <div class="box" id="husbando-lhs">
                        <div class="card-image">
                            <figure class="image is-square">
                                <img id="husbando-lhs-image" src="" alt="name">
                            </figure>
                        </div>
                        <div class="card-content">
                            <div class="content">
                                <p class="title is-4" id="husbando-lhs-title"></p>
                                <button class="button" onclick="onLike(0)">I like this one more!</button>
                                <button class="button" onclick="onDontKnow(0)">I don't know this one!</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column is-5 is-offset-2">
                    <div class="box" id="husbando-rhs">
                        <div class="card-image">
                            <figure class="image is-square">
                                <img id="husbando-rhs-image" src="" alt="name">
                            </figure>
                        </div>
                        <div class="card-content">
                            <div class="content">
                                <p class="title is-4" id="husbando-rhs-title"></p>
                                <button class="button" onclick="onLike(1)">I like this one more!</button>
                                <button class="button" onclick="onDontKnow(1)">I don't know this one!</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container" id="husbando-result">
        </div>
    </section>

    <style>
        html {
            overflow: auto;
            min-height: 100vh;
        }

        body {
            margin: 0px;
            padding: 0px;
            min-height: 100vh;
        }
    </style>

    <script>
        /*
         * Algorithm goes as follows:
         * Have an NxN matrix called M, where each row and column represents a husbando
         * Have it be filled out with -1, except the diagonal, which is 0
         * There will be lots of comparisons between LHS and RHS husbando
         * If LHS is liked more than RHS, then:
         *  M[LHS][RHS] = 1
         *  M[RHS][LHS] = 0
         * That way, at the end of the comparisons, if you sum the rows, you'll have
         * the number of times that a husbando was picked over another one.
         * Then it's just a matter of sorting.
         * If a husbando is unknown, then their entire row is set to 0.
        */

        const husbandos = [
            {
                name: "Colby",
                sourceVisualNovel: "Four Letter Word",
                image: "img/flw_colby.png",
            },
            {
                name: "Asher",
                sourceVisualNovel: "Four Letter Word",
                image: "img/flw_asher.png",
            },
            {
                name: "Eli",
                sourceVisualNovel: "Four Letter Word",
                image: "img/flw_eli.png",
            },
            {
                name: "Hugh",
                sourceVisualNovel: "Four Letter Word",
                image: "img/flw_hugh.png",
            },
            {
                name: "Slade",
                sourceVisualNovel: "Four Letter Word",
                image: "img/flw_slade.png",
            },
        ]

        let husbandoMatrix = []
        let nonAvailableHusbandos = new Set()
        // Index 0 is the LHS Husbando, and Index 1 is the RHS Husbando
        let husbandoCardIndexes = [0, 1]
        let areThereHusbandosLeft = true

        function initializeHusbandoMatrix() {
            const husbandoAmount = husbandos.length

            // Make the NxN 2D matrix full of -1
            let matrix = new Array(husbandoAmount).fill(0).map(() => new Array(husbandoAmount).fill(-1))

            // Fill the diagnonal with 0
            for (let i = 0; i < matrix.length; i++) {
                matrix[i][i] = 0
            }

            return matrix
        }

        function onLike(side) {
            const husbandoIndexLhs = husbandoCardIndexes[side]
            const husbandoIndexRhs = husbandoCardIndexes[1 - side]

            husbandoMatrix[husbandoIndexLhs][husbandoIndexRhs] = 1
            husbandoMatrix[husbandoIndexRhs][husbandoIndexLhs] = 0

            updateHusbandosState(side)
        }

        function onDontKnow(side) {
            const husbandoIndex = husbandoCardIndexes[side]

            // Fill the husbando row and column with 0
            // so that it doesn't get picked again
            // and so that the sum doesn't go up in the end
            for (let i = 0; i < husbandos.length; i++) {
                husbandoMatrix[husbandoIndex][i] = 0
                husbandoMatrix[i][husbandoIndex] = 0
            }

            updateHusbandosState(side)
        }

        /**
         * This function checks to see if any husbando got fully compared already.
         * If it has, then it needs to add it to the nonAvailableHusbandos set.
         *
         * It also checks if all the husbandos have been compared. If that's the
         * case, it will return true.
         *
         * Otherwise, it will randomize the husbando indexes and return false.
         */
        function updateHusbandosState(side) {

            for (let i = 0; i < husbandoMatrix.length; i++) {
                let available = false
                for (let j = 0; j < husbandoMatrix.length; j++) {
                    if (husbandoMatrix[i][j] === -1) {
                        available = true
                        break
                    }
                }

                if (!available) {
                    nonAvailableHusbandos.add(i)
                }
            }

            areThereHusbandosLeft = nonAvailableHusbandos.size !== husbandos.length

            if (areThereHusbandosLeft) {
                randomizeHusbandoIndex(side)
            } else {
                // The ranking has conclused, so show results
                console.log("Ranking finished")
                document.getElementById("husbando-app").style.display = "none"

                let rankedHusbandos = husbandoMatrix.map((husbando, index) => [husbando.reduce((a, b) => a + b, 0), index])

                rankedHusbandos.sort(([rank1, index1], [rank2, index2]) => rank1 < rank2)

                rankedHusbandos = rankedHusbandos.map(([rank, index]) => index)

                let rankedHusbandosHtml = `
                    <div class="box has-text-centered">
                        <p class="title">Results</p>
                    </div>
                `
                for (const [rank, index] of rankedHusbandos.entries()) {
                    rankedHusbandosHtml += `
                        <div class="box">
                            <div class="media">
                                <div class="media-left">
                                    <figure class="image is-48x48">
                                        <img src="${husbandos[index].image}">
                                    </figure>
                                </div>
                                <div class="media-content">
                                    <p class="title is-4">${rank + 1} - ${husbandos[index].name}</p>
                                    <p class="subtitle is-6">${husbandos[index].sourceVisualNovel}</p>
                                </div>
                            </div>
                            <p></p>
                        </div>
                    `
                }

                document.getElementById("husbando-result").innerHTML = rankedHusbandosHtml
            }
        }

        function randomizeHusbandoIndex(side) {
            // Randomize current side first, then check to see if the other side
            // has an available husbando. If no, then randomize the other side.
            randomizeHusbandoSide(side)

            const husbandoOtherSide = husbandoCardIndexes[1 - side]

            const husbandoIsAvailable = !nonAvailableHusbandos.has(husbandoOtherSide)

            if (!husbandoIsAvailable) {
                randomizeHusbandoSide(1 - side)
            }

            updateHusbandoCards()
        }

        function randomizeHusbandoSide(side) {
            const husbandoAmount = husbandos.length

            const oldIndex = husbandoCardIndexes[side]
            const otherIndex = husbandoCardIndexes[1 - side]

            // This is all the non available husbandos, plus the two currently selected husbandos
            const allNonAvailableHusbandos = new Set([...nonAvailableHusbandos]).add(oldIndex).add(otherIndex)

            const availableHusbandos = Array.from(Array(husbandoAmount).keys())
                // Subtract non available husbandos from all the husbandos
                .filter(x => !allNonAvailableHusbandos.has(x))
                // Subtract any husbandos that have been paired with the otherIndex
                .filter(x => husbandoMatrix[x][otherIndex] === -1)

            shuffleArray(availableHusbandos)

            if (availableHusbandos.length !== 0) {
                husbandoCardIndexes[side] = availableHusbandos[0]
            }
        }

        function updateHusbandoCards() {
            const husbandoIndexLhs = husbandoCardIndexes[0]
            const husbandoIndexRhs = husbandoCardIndexes[1]

            document.getElementById("husbando-lhs-title").textContent = `${husbandos[husbandoIndexLhs].name} (${husbandos[husbandoIndexLhs].sourceVisualNovel})`
            document.getElementById("husbando-lhs-image").src = husbandos[husbandoIndexLhs].image
            document.getElementById("husbando-lhs-image").alt = husbandos[husbandoIndexLhs].name

            document.getElementById("husbando-rhs-title").textContent = `${husbandos[husbandoIndexRhs].name} (${husbandos[husbandoIndexRhs].sourceVisualNovel})`
            document.getElementById("husbando-rhs-image").src = husbandos[husbandoIndexRhs].image
            document.getElementById("husbando-rhs-image").alt = husbandos[husbandoIndexRhs].name
        }

        function shuffleArray(a) {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]]
            }
            return a
        }

        window.onload = () => {
            husbandoMatrix = initializeHusbandoMatrix()

            randomizeHusbandoIndex(0)
            randomizeHusbandoIndex(1)
        }

    </script>
</body>

</html>